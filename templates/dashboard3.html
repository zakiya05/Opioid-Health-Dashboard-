<!DOCTYPE html>
<html>
<head>
    <title>Opioid Dashboard Connector</title>
    <meta http-equiv="Cache-Control" content="no-store" />
    
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.0.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container mt-5">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white text-center">
                <h3>Opioid Data Connector</h3>
            </div>
            <div class="card-body text-center">
                <p class="lead">Connect your MySQL database to Tableau.</p>
                <p>This will import <strong>Encounters, Medications, and Diagnoses</strong>.</p>
                <button id="submitButton" class="btn btn-success btn-lg px-5">Get Data</button>
                <div id="statusMessage" class="mt-3 text-muted"></div>
            </div>
        </div>
    </div>

<script>
    (function() {
        var myConnector = tableau.makeConnector();
        myConnector.getSchema = function(schemaCallback) {
            var cols = [
                { id: "Encounter_id", alias: "Encounter ID", dataType: tableau.dataTypeEnum.int },
                { id: "Age_in_years", alias: "Age", dataType: tableau.dataTypeEnum.int },
                { id: "Gender", alias: "Gender", dataType: tableau.dataTypeEnum.string },
                { id: "Race", alias: "Race", dataType: tableau.dataTypeEnum.string },
                { id: "Department", alias: "Department", dataType: tableau.dataTypeEnum.string },
                { id: "Discharge_Status", alias: "Discharge Status", dataType: tableau.dataTypeEnum.string },
                { id: "Medication_Name", alias: "Medication Name", dataType: tableau.dataTypeEnum.string },
                { id: "Dosage", alias: "Dosage", dataType: tableau.dataTypeEnum.string },
                { id: "Med_Start_Time", alias: "Med Start Time", dataType: tableau.dataTypeEnum.datetime },
                { id: "Diagnosis_Code", alias: "Diagnosis Code", dataType: tableau.dataTypeEnum.string },
                { id: "Diagnosis_Desc", alias: "Diagnosis Description", dataType: tableau.dataTypeEnum.string },
                { id: "Is_Opioid", alias: "Is Opioid (1=Yes)", dataType: tableau.dataTypeEnum.int },
                { id: "Is_Naloxone", alias: "Is Naloxone (1=Yes)", dataType: tableau.dataTypeEnum.int },
                { id: "Is_Overdose", alias: "Is Overdose (1=Yes)", dataType: tableau.dataTypeEnum.int }
            ];

            var tableSchema = {
                id: "OpioidMasterData",
                alias: "Opioid Stewardship & Safety Data",
                columns: cols
            };

            schemaCallback([tableSchema]);
        };

        myConnector.getData = function(table, doneCallback) {
            $.getJSON("http://localhost:5000/api/tableau-opioid-data", function(resp) {
                var tableData = [];
                for (var i = 0, len = resp.length; i < len; i++) {
                    tableData.push({
                        "Encounter_id": resp[i].Encounter_id,
                        "Age_in_years": resp[i].Age_in_years,
                        "Gender": resp[i].Gender,
                        "Race": resp[i].Race,
                        "Department": resp[i].Department,
                        "Discharge_Status": resp[i].Discharge_Status,
                        "Medication_Name": resp[i].Medication_Name,
                        "Dosage": resp[i].Dosage,
                        "Med_Start_Time": resp[i].Med_Start_Time,
                        "Diagnosis_Code": resp[i].Diagnosis_Code,
                        "Diagnosis_Desc": resp[i].Diagnosis_Desc,
                        "Is_Opioid": resp[i].Is_Opioid,
                        "Is_Naloxone": resp[i].Is_Naloxone,
                        "Is_Overdose": resp[i].Is_Overdose
                    });
                }

                table.appendRows(tableData);
                doneCallback();
            });
        };

        tableau.registerConnector(myConnector);
        $(document).ready(function() {
            $("#submitButton").click(function() {
                $("#statusMessage").text("Connecting to database...");
                tableau.connectionName = "Opioid Stewardship Data"; 
                tableau.submit(); 
            });
        });
    })();
</script>
</body>
</html>